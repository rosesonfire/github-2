'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
// TODO: test for invalid url
// TODO: authentication and secret keys
// TODO: should not directly send the requestID
/**
 * Creates a response buffer
 * @param {Number} requestBufferLimit the size of the buffer
 * @param {Number} ttl the maximum time (in milliseconds) to live for each async
 *                     task
 */
var createResponseBuffer = function createResponseBuffer(requestBufferLimit, ttl) {
  var responseBuffer = {
    _buffer: {}
  };
  var requestIDs = Array(requestBufferLimit).fill(0).map(function (value, index) {
    return index;
  });

  // Removes the timedout buffered responses from the response buffer
  responseBuffer.clean = function () {
    var now = Date.now();
    var buffer = responseBuffer._buffer;
    Object.keys(buffer).forEach(function (requestID) {
      if (now - buffer[requestID].creationTime > ttl) {
        delete buffer[requestID];
      }
    });
  };

  // Gets the id of an available slot in the buffer
  responseBuffer.getNewID = function () {
    responseBuffer.clean();

    var buffer = responseBuffer._buffer;

    return requestIDs.find(function (id) {
      return !(id in buffer);
    });
  };

  // Pushes a new bufferedResponse into the responseBuffer
  responseBuffer.push = function (requestID, bufferedResponse) {
    responseBuffer._buffer[requestID] = bufferedResponse;
  };

  // Gets an existing bufferedResponse from the responseBuffer
  responseBuffer.get = function (requestID) {
    return responseBuffer._buffer[requestID];
  };

  // Deletes an existing bufferedResponse from the responseBuffer
  responseBuffer.remove = function (requestID) {
    return delete responseBuffer._buffer[requestID];
  };

  return responseBuffer;
};

// Create a buffered response to be added to the response buffer
var createBufferedResponse = function createBufferedResponse() {
  var bufferedResponse = {
    completed: false,
    succeeded: false,
    response: null,
    error: null,
    creationTime: Date.now()
    // Called once the underlying async task succeeds
  };bufferedResponse.resolve = function (response) {
    bufferedResponse.completed = true;
    bufferedResponse.succeeded = true;
    bufferedResponse.response = response;
  };
  // Called once the underlying async task fails
  bufferedResponse.reject = function (error) {
    bufferedResponse.completed = true;
    bufferedResponse.succeeded = false;
    bufferedResponse.error = error;
  };

  return bufferedResponse;
};

// Set the relevant method into the response object
var decorateResponseObject = function decorateResponseObject(res, bufferedResponse) {
  res.setBufferedResponse = function (asyncTask) {
    if (!asyncTask.then || !asyncTask.catch) {
      // If the underlying task is not asynchronous, the throw an error
      throw new Error('Task must be a promise');
    }
    asyncTask.then(bufferedResponse.resolve).catch(bufferedResponse.reject);
  };
};

var handleRequestForNewTask = function handleRequestForNewTask(res, next, responseBuffer) {
  var requestID = responseBuffer.getNewID();

  if (requestID === undefined) {
    res.status(503).json({ error: 'Request queue is overloaded.' });
  } else {
    var bufferedResponse = createBufferedResponse();

    responseBuffer.push(requestID, bufferedResponse);
    decorateResponseObject(res, bufferedResponse);
    next();
    res.status(202).json({ requestID: requestID });
  }
};

var handleRequestForBufferedTask = function handleRequestForBufferedTask(requestID, res, responseBuffer) {
  var bufferedResponse = responseBuffer.get(requestID);

  if (bufferedResponse) {
    if (bufferedResponse.completed) {
      responseBuffer.remove(requestID);

      if (bufferedResponse.succeeded) {
        // TODO: test for cases where response is not an object
        res.status(200).json(bufferedResponse.response);
      } else {
        res.status(500).json(bufferedResponse.error);
      }
    } else {
      res.sendStatus(202);
    }
  } else {
    res.sendStatus(404);
  }
};

/**
 * The RequestBuffer middleware
 * @param {Number} requestBufferLimit the size of the buffer
 * @param {Number} ttl the maximum time (in milliseconds) to live for each async
 *               task
 */

exports.default = function (_ref) {
  var requestBufferLimit = _ref.requestBufferLimit,
      ttl = _ref.ttl;

  var responseBuffer = createResponseBuffer(requestBufferLimit, ttl);

  return function (req, res, next) {
    if (req.body.requestID === undefined) {
      handleRequestForNewTask(res, next, responseBuffer);
    } else {
      var requestID = req.body.requestID;

      handleRequestForBufferedTask(requestID, res, responseBuffer);
    }
  };
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYWluL21pZGRsZXdhcmVzL3JlcXVlc3RCdWZmZXIuanMiXSwibmFtZXMiOlsiY3JlYXRlUmVzcG9uc2VCdWZmZXIiLCJyZXF1ZXN0QnVmZmVyTGltaXQiLCJ0dGwiLCJyZXNwb25zZUJ1ZmZlciIsIl9idWZmZXIiLCJyZXF1ZXN0SURzIiwiQXJyYXkiLCJmaWxsIiwibWFwIiwidmFsdWUiLCJpbmRleCIsImNsZWFuIiwibm93IiwiRGF0ZSIsImJ1ZmZlciIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwicmVxdWVzdElEIiwiY3JlYXRpb25UaW1lIiwiZ2V0TmV3SUQiLCJmaW5kIiwiaWQiLCJwdXNoIiwiYnVmZmVyZWRSZXNwb25zZSIsImdldCIsInJlbW92ZSIsImNyZWF0ZUJ1ZmZlcmVkUmVzcG9uc2UiLCJjb21wbGV0ZWQiLCJzdWNjZWVkZWQiLCJyZXNwb25zZSIsImVycm9yIiwicmVzb2x2ZSIsInJlamVjdCIsImRlY29yYXRlUmVzcG9uc2VPYmplY3QiLCJyZXMiLCJzZXRCdWZmZXJlZFJlc3BvbnNlIiwiYXN5bmNUYXNrIiwidGhlbiIsImNhdGNoIiwiRXJyb3IiLCJoYW5kbGVSZXF1ZXN0Rm9yTmV3VGFzayIsIm5leHQiLCJ1bmRlZmluZWQiLCJzdGF0dXMiLCJqc29uIiwiaGFuZGxlUmVxdWVzdEZvckJ1ZmZlcmVkVGFzayIsInNlbmRTdGF0dXMiLCJyZXEiLCJib2R5Il0sIm1hcHBpbmdzIjoiOzs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBOzs7Ozs7QUFNQSxJQUFNQSx1QkFBdUIsU0FBdkJBLG9CQUF1QixDQUFDQyxrQkFBRCxFQUFxQkMsR0FBckIsRUFBNkI7QUFDeEQsTUFBTUMsaUJBQWlCO0FBQ3JCQyxhQUFTO0FBRFksR0FBdkI7QUFHQSxNQUFNQyxhQUFhQyxNQUFNTCxrQkFBTixFQUEwQk0sSUFBMUIsQ0FBK0IsQ0FBL0IsRUFDaEJDLEdBRGdCLENBQ1osVUFBQ0MsS0FBRCxFQUFRQyxLQUFSO0FBQUEsV0FBa0JBLEtBQWxCO0FBQUEsR0FEWSxDQUFuQjs7QUFHQTtBQUNBUCxpQkFBZVEsS0FBZixHQUF1QixZQUFNO0FBQzNCLFFBQU1DLE1BQU1DLEtBQUtELEdBQUwsRUFBWjtBQUNBLFFBQU1FLFNBQVNYLGVBQWVDLE9BQTlCO0FBQ0FXLFdBQU9DLElBQVAsQ0FBWUYsTUFBWixFQUFvQkcsT0FBcEIsQ0FBNEIscUJBQWE7QUFDdkMsVUFBSUwsTUFBTUUsT0FBT0ksU0FBUCxFQUFrQkMsWUFBeEIsR0FBdUNqQixHQUEzQyxFQUFnRDtBQUM5QyxlQUFPWSxPQUFPSSxTQUFQLENBQVA7QUFDRDtBQUNGLEtBSkQ7QUFLRCxHQVJEOztBQVVBO0FBQ0FmLGlCQUFlaUIsUUFBZixHQUEwQixZQUFNO0FBQzlCakIsbUJBQWVRLEtBQWY7O0FBRUEsUUFBTUcsU0FBU1gsZUFBZUMsT0FBOUI7O0FBRUEsV0FBT0MsV0FBV2dCLElBQVgsQ0FBZ0I7QUFBQSxhQUFNLEVBQUVDLE1BQU1SLE1BQVIsQ0FBTjtBQUFBLEtBQWhCLENBQVA7QUFDRCxHQU5EOztBQVFBO0FBQ0FYLGlCQUFlb0IsSUFBZixHQUFzQixVQUFDTCxTQUFELEVBQVlNLGdCQUFaLEVBQWlDO0FBQ3JEckIsbUJBQWVDLE9BQWYsQ0FBdUJjLFNBQXZCLElBQW9DTSxnQkFBcEM7QUFDRCxHQUZEOztBQUlBO0FBQ0FyQixpQkFBZXNCLEdBQWYsR0FBcUIsVUFBQ1AsU0FBRDtBQUFBLFdBQWVmLGVBQWVDLE9BQWYsQ0FBdUJjLFNBQXZCLENBQWY7QUFBQSxHQUFyQjs7QUFFQTtBQUNBZixpQkFBZXVCLE1BQWYsR0FBd0IsVUFBQ1IsU0FBRDtBQUFBLFdBQ3RCLE9BQU9mLGVBQWVDLE9BQWYsQ0FBdUJjLFNBQXZCLENBRGU7QUFBQSxHQUF4Qjs7QUFHQSxTQUFPZixjQUFQO0FBQ0QsQ0F4Q0Q7O0FBMENBO0FBQ0EsSUFBTXdCLHlCQUF5QixTQUF6QkEsc0JBQXlCLEdBQU07QUFDbkMsTUFBTUgsbUJBQW1CO0FBQ3ZCSSxlQUFXLEtBRFk7QUFFdkJDLGVBQVcsS0FGWTtBQUd2QkMsY0FBVSxJQUhhO0FBSXZCQyxXQUFPLElBSmdCO0FBS3ZCWixrQkFBY04sS0FBS0QsR0FBTDtBQUVoQjtBQVB5QixHQUF6QixDQVFBWSxpQkFBaUJRLE9BQWpCLEdBQTJCLFVBQUNGLFFBQUQsRUFBYztBQUN2Q04scUJBQWlCSSxTQUFqQixHQUE2QixJQUE3QjtBQUNBSixxQkFBaUJLLFNBQWpCLEdBQTZCLElBQTdCO0FBQ0FMLHFCQUFpQk0sUUFBakIsR0FBNEJBLFFBQTVCO0FBQ0QsR0FKRDtBQUtBO0FBQ0FOLG1CQUFpQlMsTUFBakIsR0FBMEIsVUFBQ0YsS0FBRCxFQUFXO0FBQ25DUCxxQkFBaUJJLFNBQWpCLEdBQTZCLElBQTdCO0FBQ0FKLHFCQUFpQkssU0FBakIsR0FBNkIsS0FBN0I7QUFDQUwscUJBQWlCTyxLQUFqQixHQUF5QkEsS0FBekI7QUFDRCxHQUpEOztBQU1BLFNBQU9QLGdCQUFQO0FBQ0QsQ0F0QkQ7O0FBd0JBO0FBQ0EsSUFBTVUseUJBQXlCLFNBQXpCQSxzQkFBeUIsQ0FBQ0MsR0FBRCxFQUFNWCxnQkFBTixFQUEyQjtBQUN4RFcsTUFBSUMsbUJBQUosR0FBMEIsVUFBQ0MsU0FBRCxFQUFlO0FBQ3ZDLFFBQUksQ0FBQ0EsVUFBVUMsSUFBWCxJQUFtQixDQUFDRCxVQUFVRSxLQUFsQyxFQUF5QztBQUN2QztBQUNBLFlBQU0sSUFBSUMsS0FBSixDQUFVLHdCQUFWLENBQU47QUFDRDtBQUNESCxjQUNHQyxJQURILENBQ1FkLGlCQUFpQlEsT0FEekIsRUFFR08sS0FGSCxDQUVTZixpQkFBaUJTLE1BRjFCO0FBR0QsR0FSRDtBQVNELENBVkQ7O0FBWUEsSUFBTVEsMEJBQTBCLFNBQTFCQSx1QkFBMEIsQ0FBQ04sR0FBRCxFQUFNTyxJQUFOLEVBQVl2QyxjQUFaLEVBQStCO0FBQzdELE1BQU1lLFlBQVlmLGVBQWVpQixRQUFmLEVBQWxCOztBQUVBLE1BQUlGLGNBQWN5QixTQUFsQixFQUE2QjtBQUMzQlIsUUFBSVMsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLEVBQUVkLE9BQU8sOEJBQVQsRUFBckI7QUFDRCxHQUZELE1BRU87QUFDTCxRQUFNUCxtQkFBbUJHLHdCQUF6Qjs7QUFFQXhCLG1CQUFlb0IsSUFBZixDQUFvQkwsU0FBcEIsRUFBK0JNLGdCQUEvQjtBQUNBVSwyQkFBdUJDLEdBQXZCLEVBQTRCWCxnQkFBNUI7QUFDQWtCO0FBQ0FQLFFBQUlTLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixFQUFFM0Isb0JBQUYsRUFBckI7QUFDRDtBQUNGLENBYkQ7O0FBZUEsSUFBTTRCLCtCQUErQixTQUEvQkEsNEJBQStCLENBQUM1QixTQUFELEVBQVlpQixHQUFaLEVBQWlCaEMsY0FBakIsRUFBb0M7QUFDdkUsTUFBTXFCLG1CQUFtQnJCLGVBQWVzQixHQUFmLENBQW1CUCxTQUFuQixDQUF6Qjs7QUFFQSxNQUFJTSxnQkFBSixFQUFzQjtBQUNwQixRQUFJQSxpQkFBaUJJLFNBQXJCLEVBQWdDO0FBQzlCekIscUJBQWV1QixNQUFmLENBQXNCUixTQUF0Qjs7QUFFQSxVQUFJTSxpQkFBaUJLLFNBQXJCLEVBQWdDO0FBQzlCO0FBQ0FNLFlBQUlTLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQnJCLGlCQUFpQk0sUUFBdEM7QUFDRCxPQUhELE1BR087QUFDTEssWUFBSVMsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCckIsaUJBQWlCTyxLQUF0QztBQUNEO0FBQ0YsS0FURCxNQVNPO0FBQ0xJLFVBQUlZLFVBQUosQ0FBZSxHQUFmO0FBQ0Q7QUFDRixHQWJELE1BYU87QUFDTFosUUFBSVksVUFBSixDQUFlLEdBQWY7QUFDRDtBQUNGLENBbkJEOztBQXFCQTs7Ozs7OztrQkFNZSxnQkFBaUM7QUFBQSxNQUE5QjlDLGtCQUE4QixRQUE5QkEsa0JBQThCO0FBQUEsTUFBVkMsR0FBVSxRQUFWQSxHQUFVOztBQUM5QyxNQUFNQyxpQkFBaUJILHFCQUFxQkMsa0JBQXJCLEVBQXlDQyxHQUF6QyxDQUF2Qjs7QUFFQSxTQUFPLFVBQUM4QyxHQUFELEVBQU1iLEdBQU4sRUFBV08sSUFBWCxFQUFvQjtBQUN6QixRQUFJTSxJQUFJQyxJQUFKLENBQVMvQixTQUFULEtBQXVCeUIsU0FBM0IsRUFBc0M7QUFDcENGLDhCQUF3Qk4sR0FBeEIsRUFBNkJPLElBQTdCLEVBQW1DdkMsY0FBbkM7QUFDRCxLQUZELE1BRU87QUFDTCxVQUFNZSxZQUFZOEIsSUFBSUMsSUFBSixDQUFTL0IsU0FBM0I7O0FBRUE0QixtQ0FBNkI1QixTQUE3QixFQUF3Q2lCLEdBQXhDLEVBQTZDaEMsY0FBN0M7QUFDRDtBQUNGLEdBUkQ7QUFTRCxDIiwiZmlsZSI6InJlcXVlc3RCdWZmZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUT0RPOiB0ZXN0IGZvciBpbnZhbGlkIHVybFxuLy8gVE9ETzogYXV0aGVudGljYXRpb24gYW5kIHNlY3JldCBrZXlzXG4vLyBUT0RPOiBzaG91bGQgbm90IGRpcmVjdGx5IHNlbmQgdGhlIHJlcXVlc3RJRFxuLyoqXG4gKiBDcmVhdGVzIGEgcmVzcG9uc2UgYnVmZmVyXG4gKiBAcGFyYW0ge051bWJlcn0gcmVxdWVzdEJ1ZmZlckxpbWl0IHRoZSBzaXplIG9mIHRoZSBidWZmZXJcbiAqIEBwYXJhbSB7TnVtYmVyfSB0dGwgdGhlIG1heGltdW0gdGltZSAoaW4gbWlsbGlzZWNvbmRzKSB0byBsaXZlIGZvciBlYWNoIGFzeW5jXG4gKiAgICAgICAgICAgICAgICAgICAgIHRhc2tcbiAqL1xuY29uc3QgY3JlYXRlUmVzcG9uc2VCdWZmZXIgPSAocmVxdWVzdEJ1ZmZlckxpbWl0LCB0dGwpID0+IHtcbiAgY29uc3QgcmVzcG9uc2VCdWZmZXIgPSB7XG4gICAgX2J1ZmZlcjoge31cbiAgfVxuICBjb25zdCByZXF1ZXN0SURzID0gQXJyYXkocmVxdWVzdEJ1ZmZlckxpbWl0KS5maWxsKDApXG4gICAgLm1hcCgodmFsdWUsIGluZGV4KSA9PiBpbmRleClcblxuICAvLyBSZW1vdmVzIHRoZSB0aW1lZG91dCBidWZmZXJlZCByZXNwb25zZXMgZnJvbSB0aGUgcmVzcG9uc2UgYnVmZmVyXG4gIHJlc3BvbnNlQnVmZmVyLmNsZWFuID0gKCkgPT4ge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KClcbiAgICBjb25zdCBidWZmZXIgPSByZXNwb25zZUJ1ZmZlci5fYnVmZmVyXG4gICAgT2JqZWN0LmtleXMoYnVmZmVyKS5mb3JFYWNoKHJlcXVlc3RJRCA9PiB7XG4gICAgICBpZiAobm93IC0gYnVmZmVyW3JlcXVlc3RJRF0uY3JlYXRpb25UaW1lID4gdHRsKSB7XG4gICAgICAgIGRlbGV0ZSBidWZmZXJbcmVxdWVzdElEXVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICAvLyBHZXRzIHRoZSBpZCBvZiBhbiBhdmFpbGFibGUgc2xvdCBpbiB0aGUgYnVmZmVyXG4gIHJlc3BvbnNlQnVmZmVyLmdldE5ld0lEID0gKCkgPT4ge1xuICAgIHJlc3BvbnNlQnVmZmVyLmNsZWFuKClcblxuICAgIGNvbnN0IGJ1ZmZlciA9IHJlc3BvbnNlQnVmZmVyLl9idWZmZXJcblxuICAgIHJldHVybiByZXF1ZXN0SURzLmZpbmQoaWQgPT4gIShpZCBpbiBidWZmZXIpKVxuICB9XG5cbiAgLy8gUHVzaGVzIGEgbmV3IGJ1ZmZlcmVkUmVzcG9uc2UgaW50byB0aGUgcmVzcG9uc2VCdWZmZXJcbiAgcmVzcG9uc2VCdWZmZXIucHVzaCA9IChyZXF1ZXN0SUQsIGJ1ZmZlcmVkUmVzcG9uc2UpID0+IHtcbiAgICByZXNwb25zZUJ1ZmZlci5fYnVmZmVyW3JlcXVlc3RJRF0gPSBidWZmZXJlZFJlc3BvbnNlXG4gIH1cblxuICAvLyBHZXRzIGFuIGV4aXN0aW5nIGJ1ZmZlcmVkUmVzcG9uc2UgZnJvbSB0aGUgcmVzcG9uc2VCdWZmZXJcbiAgcmVzcG9uc2VCdWZmZXIuZ2V0ID0gKHJlcXVlc3RJRCkgPT4gcmVzcG9uc2VCdWZmZXIuX2J1ZmZlcltyZXF1ZXN0SURdXG5cbiAgLy8gRGVsZXRlcyBhbiBleGlzdGluZyBidWZmZXJlZFJlc3BvbnNlIGZyb20gdGhlIHJlc3BvbnNlQnVmZmVyXG4gIHJlc3BvbnNlQnVmZmVyLnJlbW92ZSA9IChyZXF1ZXN0SUQpID0+XG4gICAgZGVsZXRlIHJlc3BvbnNlQnVmZmVyLl9idWZmZXJbcmVxdWVzdElEXVxuXG4gIHJldHVybiByZXNwb25zZUJ1ZmZlclxufVxuXG4vLyBDcmVhdGUgYSBidWZmZXJlZCByZXNwb25zZSB0byBiZSBhZGRlZCB0byB0aGUgcmVzcG9uc2UgYnVmZmVyXG5jb25zdCBjcmVhdGVCdWZmZXJlZFJlc3BvbnNlID0gKCkgPT4ge1xuICBjb25zdCBidWZmZXJlZFJlc3BvbnNlID0ge1xuICAgIGNvbXBsZXRlZDogZmFsc2UsXG4gICAgc3VjY2VlZGVkOiBmYWxzZSxcbiAgICByZXNwb25zZTogbnVsbCxcbiAgICBlcnJvcjogbnVsbCxcbiAgICBjcmVhdGlvblRpbWU6IERhdGUubm93KClcbiAgfVxuICAvLyBDYWxsZWQgb25jZSB0aGUgdW5kZXJseWluZyBhc3luYyB0YXNrIHN1Y2NlZWRzXG4gIGJ1ZmZlcmVkUmVzcG9uc2UucmVzb2x2ZSA9IChyZXNwb25zZSkgPT4ge1xuICAgIGJ1ZmZlcmVkUmVzcG9uc2UuY29tcGxldGVkID0gdHJ1ZVxuICAgIGJ1ZmZlcmVkUmVzcG9uc2Uuc3VjY2VlZGVkID0gdHJ1ZVxuICAgIGJ1ZmZlcmVkUmVzcG9uc2UucmVzcG9uc2UgPSByZXNwb25zZVxuICB9XG4gIC8vIENhbGxlZCBvbmNlIHRoZSB1bmRlcmx5aW5nIGFzeW5jIHRhc2sgZmFpbHNcbiAgYnVmZmVyZWRSZXNwb25zZS5yZWplY3QgPSAoZXJyb3IpID0+IHtcbiAgICBidWZmZXJlZFJlc3BvbnNlLmNvbXBsZXRlZCA9IHRydWVcbiAgICBidWZmZXJlZFJlc3BvbnNlLnN1Y2NlZWRlZCA9IGZhbHNlXG4gICAgYnVmZmVyZWRSZXNwb25zZS5lcnJvciA9IGVycm9yXG4gIH1cblxuICByZXR1cm4gYnVmZmVyZWRSZXNwb25zZVxufVxuXG4vLyBTZXQgdGhlIHJlbGV2YW50IG1ldGhvZCBpbnRvIHRoZSByZXNwb25zZSBvYmplY3RcbmNvbnN0IGRlY29yYXRlUmVzcG9uc2VPYmplY3QgPSAocmVzLCBidWZmZXJlZFJlc3BvbnNlKSA9PiB7XG4gIHJlcy5zZXRCdWZmZXJlZFJlc3BvbnNlID0gKGFzeW5jVGFzaykgPT4ge1xuICAgIGlmICghYXN5bmNUYXNrLnRoZW4gfHwgIWFzeW5jVGFzay5jYXRjaCkge1xuICAgICAgLy8gSWYgdGhlIHVuZGVybHlpbmcgdGFzayBpcyBub3QgYXN5bmNocm9ub3VzLCB0aGUgdGhyb3cgYW4gZXJyb3JcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGFzayBtdXN0IGJlIGEgcHJvbWlzZScpXG4gICAgfVxuICAgIGFzeW5jVGFza1xuICAgICAgLnRoZW4oYnVmZmVyZWRSZXNwb25zZS5yZXNvbHZlKVxuICAgICAgLmNhdGNoKGJ1ZmZlcmVkUmVzcG9uc2UucmVqZWN0KVxuICB9XG59XG5cbmNvbnN0IGhhbmRsZVJlcXVlc3RGb3JOZXdUYXNrID0gKHJlcywgbmV4dCwgcmVzcG9uc2VCdWZmZXIpID0+IHtcbiAgY29uc3QgcmVxdWVzdElEID0gcmVzcG9uc2VCdWZmZXIuZ2V0TmV3SUQoKVxuXG4gIGlmIChyZXF1ZXN0SUQgPT09IHVuZGVmaW5lZCkge1xuICAgIHJlcy5zdGF0dXMoNTAzKS5qc29uKHsgZXJyb3I6ICdSZXF1ZXN0IHF1ZXVlIGlzIG92ZXJsb2FkZWQuJyB9KVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGJ1ZmZlcmVkUmVzcG9uc2UgPSBjcmVhdGVCdWZmZXJlZFJlc3BvbnNlKClcblxuICAgIHJlc3BvbnNlQnVmZmVyLnB1c2gocmVxdWVzdElELCBidWZmZXJlZFJlc3BvbnNlKVxuICAgIGRlY29yYXRlUmVzcG9uc2VPYmplY3QocmVzLCBidWZmZXJlZFJlc3BvbnNlKVxuICAgIG5leHQoKVxuICAgIHJlcy5zdGF0dXMoMjAyKS5qc29uKHsgcmVxdWVzdElEIH0pXG4gIH1cbn1cblxuY29uc3QgaGFuZGxlUmVxdWVzdEZvckJ1ZmZlcmVkVGFzayA9IChyZXF1ZXN0SUQsIHJlcywgcmVzcG9uc2VCdWZmZXIpID0+IHtcbiAgY29uc3QgYnVmZmVyZWRSZXNwb25zZSA9IHJlc3BvbnNlQnVmZmVyLmdldChyZXF1ZXN0SUQpXG5cbiAgaWYgKGJ1ZmZlcmVkUmVzcG9uc2UpIHtcbiAgICBpZiAoYnVmZmVyZWRSZXNwb25zZS5jb21wbGV0ZWQpIHtcbiAgICAgIHJlc3BvbnNlQnVmZmVyLnJlbW92ZShyZXF1ZXN0SUQpXG5cbiAgICAgIGlmIChidWZmZXJlZFJlc3BvbnNlLnN1Y2NlZWRlZCkge1xuICAgICAgICAvLyBUT0RPOiB0ZXN0IGZvciBjYXNlcyB3aGVyZSByZXNwb25zZSBpcyBub3QgYW4gb2JqZWN0XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKGJ1ZmZlcmVkUmVzcG9uc2UucmVzcG9uc2UpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbihidWZmZXJlZFJlc3BvbnNlLmVycm9yKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXMuc2VuZFN0YXR1cygyMDIpXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJlcy5zZW5kU3RhdHVzKDQwNClcbiAgfVxufVxuXG4vKipcbiAqIFRoZSBSZXF1ZXN0QnVmZmVyIG1pZGRsZXdhcmVcbiAqIEBwYXJhbSB7TnVtYmVyfSByZXF1ZXN0QnVmZmVyTGltaXQgdGhlIHNpemUgb2YgdGhlIGJ1ZmZlclxuICogQHBhcmFtIHtOdW1iZXJ9IHR0bCB0aGUgbWF4aW11bSB0aW1lIChpbiBtaWxsaXNlY29uZHMpIHRvIGxpdmUgZm9yIGVhY2ggYXN5bmNcbiAqICAgICAgICAgICAgICAgdGFza1xuICovXG5leHBvcnQgZGVmYXVsdCAoeyByZXF1ZXN0QnVmZmVyTGltaXQsIHR0bCB9KSA9PiB7XG4gIGNvbnN0IHJlc3BvbnNlQnVmZmVyID0gY3JlYXRlUmVzcG9uc2VCdWZmZXIocmVxdWVzdEJ1ZmZlckxpbWl0LCB0dGwpXG5cbiAgcmV0dXJuIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIGlmIChyZXEuYm9keS5yZXF1ZXN0SUQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaGFuZGxlUmVxdWVzdEZvck5ld1Rhc2socmVzLCBuZXh0LCByZXNwb25zZUJ1ZmZlcilcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcmVxdWVzdElEID0gcmVxLmJvZHkucmVxdWVzdElEXG5cbiAgICAgIGhhbmRsZVJlcXVlc3RGb3JCdWZmZXJlZFRhc2socmVxdWVzdElELCByZXMsIHJlc3BvbnNlQnVmZmVyKVxuICAgIH1cbiAgfVxufVxuIl19